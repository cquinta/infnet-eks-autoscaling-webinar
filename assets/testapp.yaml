# Deployment da aplicação de teste para demonstração de autoscaling
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app
  labels:
    app: test-app
spec:
  replicas: 3  # Número inicial de réplicas
  selector:
    matchLabels:
      app: test-app
  template:
    metadata:
      labels:
        app: test-app
    spec:
      containers:
      - name: test-app
        image: cquinta/test-app:main  # Imagem da aplicação de teste
        env:
        - name: VERSION
          value: "v1"  # Versão da aplicação
        resources:
          requests:  # Recursos mínimos garantidos
            cpu: 250m     # 1/4 de CPU
            memory: 128Mi # 128MB de memória
          limits:    # Limites máximos de recursos
            cpu: 500m     # 1/2 de CPU
            memory: 256Mi # 256MB de memória
        ports:
        - containerPort: 8000  # Porta da aplicação
---
# Service ClusterIP para acesso interno ao deployment
apiVersion: v1
kind: Service
metadata:
  name: test-app-service
spec:
  selector:
    app: test-app
  ports:
  - port: 80          # Porta do service
    targetPort: 8000  # Porta do container
  type: ClusterIP     # Acesso apenas interno ao cluster
---
# HPA para escalonamento automático baseado em CPU
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: test-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: test-app  # Deployment alvo do autoscaling
  minReplicas: 3    # Mínimo de 3 pods
  maxReplicas: 10   # Máximo de 10 pods
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50  # Target de 50% de CPU
  behavior:
    scaleUp:  # Comportamento para escalar para cima
      stabilizationWindowSeconds: 60
      policies:
      - type: Pods
        value: 1          # Adiciona 1 pod por vez
        periodSeconds: 60 # A cada 60 segundos
    scaleDown:  # Comportamento para escalar para baixo
      stabilizationWindowSeconds: 60
      policies:
      - type: Pods
        value: 1          # Remove 1 pod por vez
        periodSeconds: 60 # A cada 60 segundos